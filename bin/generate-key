#!/usr/bin/env php
<?php

declare(strict_types=1);

$envFile = dirname(__DIR__) . '/.env';

if (! file_exists($envFile)) {
    exit(0);
}

$contents = file_get_contents($envFile);

if ($contents === false) {
    fwrite(STDERR, 'Não foi possível ler o arquivo .env' . PHP_EOL);
    exit(1);
}

$pattern = '/^APP_KEY=\s*("?)([^"\r\n]*)\1\s*$/m';

if (preg_match($pattern, $contents, $matches) === 1) {
    if ($matches[2] === '') {
        $key = 'base64:' . base64_encode(random_bytes(32));
        $updated = preg_replace($pattern, 'APP_KEY=' . $key, $contents);
        file_put_contents($envFile, $updated);
        echo '> APP_KEY gerada automaticamente.' . PHP_EOL;
    }

    exit(0);
}

$key = 'base64:' . base64_encode(random_bytes(32));
$suffix = str_ends_with($contents, PHP_EOL) ? '' : PHP_EOL;
$updated = $contents . $suffix . 'APP_KEY=' . $key . PHP_EOL;
file_put_contents($envFile, $updated);
echo '> APP_KEY adicionada ao .env.' . PHP_EOL;
